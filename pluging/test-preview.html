<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äº§å“ä¿¡æ¯é¢„è§ˆæµ‹è¯•</title>
    <link rel="stylesheet" href="popup.css">
    <style>
        body {
            width: auto;
            min-height: auto;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f8f9fa;
        }
        .test-controls {
            margin-bottom: 20px;
            padding: 16px;
            background: #e9ecef;
            border-radius: 8px;
        }
        .test-controls h2 {
            margin: 0 0 16px 0;
            color: #495057;
        }
        .test-controls button {
            margin-right: 10px;
            margin-bottom: 10px;
        }
        .debug-info {
            margin-top: 20px;
            padding: 16px;
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
        }
        .debug-info h3 {
            margin: 0 0 10px 0;
            color: #856404;
        }
        .debug-info pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }
    </style>
</head>
<body>
  <div class="test-controls">
    <h2>ğŸ§ª äº§å“ä¿¡æ¯é¢„è§ˆåŠŸèƒ½æµ‹è¯•</h2>
    
    <button class="btn btn-primary" onclick="testCompleteData()">æµ‹è¯•å®Œæ•´æ•°æ®</button>
    <button class="btn btn-secondary" onclick="testPartialData()">æµ‹è¯•éƒ¨åˆ†æ•°æ®</button>
    <button class="btn btn-warning" onclick="testEmptyData()">æµ‹è¯•ç©ºæ•°æ®</button>
    <button class="btn btn-danger" onclick="clearPreview()">æ¸…ç©ºé¢„è§ˆ</button>
    <button class="btn btn-info" onclick="showDebugInfo()">æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯</button>
  </div>
    
    <!-- äº§å“ä¿¡æ¯é¢„è§ˆåŒºåŸŸ -->
    <div id="product-preview" class="product-preview" style="display: none;">
      <h3>ğŸ“‹ æå–çš„äº§å“ä¿¡æ¯é¢„è§ˆ</h3>
      
      <!-- åŸºæœ¬ä¿¡æ¯ -->
      <div class="preview-section">
        <h4>ğŸ·ï¸ åŸºæœ¬ä¿¡æ¯</h4>
        <div class="preview-field">
          <label>äº§å“æ ‡é¢˜:</label>
          <div class="value" id="preview-title">-</div>
        </div>
        <div class="preview-field">
          <label>äº§å“ID:</label>
          <div class="value" id="preview-product-id">-</div>
        </div>
        <div class="preview-field">
          <label>ä»·æ ¼:</label>
          <div class="value price" id="preview-price">-</div>
        </div>
        <div class="preview-field">
          <label>æœ€å°èµ·è®¢é‡:</label>
          <div class="value" id="preview-min-order">-</div>
        </div>
        <div class="preview-field">
          <label>å•ä½:</label>
          <div class="value" id="preview-unit">-</div>
        </div>
      </div>
      
      <!-- ä¾›åº”å•†ä¿¡æ¯ -->
      <div class="preview-section">
        <h4>ğŸ¢ ä¾›åº”å•†ä¿¡æ¯</h4>
        <div class="preview-field">
          <label>ä¾›åº”å•†åç§°:</label>
          <div class="value" id="preview-supplier">-</div>
        </div>
        <div class="preview-field">
          <label>ä¾›åº”å•†ä½ç½®:</label>
          <div class="value" id="preview-location">-</div>
        </div>
      </div>
      
      <!-- å›¾ç‰‡ä¿¡æ¯ -->
      <div class="preview-section">
        <h4>ğŸ–¼ï¸ å›¾ç‰‡ä¿¡æ¯</h4>
        <div class="preview-field">
          <label>ä¸»å›¾:</label>
          <div class="image-container" id="preview-main-image">
            <div class="no-image">æœªæå–åˆ°ä¸»å›¾</div>
          </div>
        </div>
        <div class="preview-field">
          <label>è½®æ’­å›¾ (<span id="carousel-count">0</span>å¼ ):</label>
          <div class="image-gallery" id="preview-carousel-images">
            <div class="no-image">æœªæå–åˆ°è½®æ’­å›¾</div>
          </div>
        </div>
        <div class="preview-field">
          <label>è¯¦æƒ…å›¾ (<span id="detail-count">0</span>å¼ ):</label>
          <div class="image-gallery" id="preview-detail-images">
            <div class="no-image">æœªæå–åˆ°è¯¦æƒ…å›¾</div>
          </div>
        </div>
      </div>
      
      <!-- å…¶ä»–ä¿¡æ¯ -->
      <div class="preview-section">
        <h4>ğŸ“ å…¶ä»–ä¿¡æ¯</h4>
        <div class="preview-field">
          <label>åˆ†ç±»:</label>
          <div class="value" id="preview-category">-</div>
        </div>
        <div class="preview-field">
          <label>äº§å“æè¿°:</label>
          <div class="value description" id="preview-description">-</div>
        </div>
        <div class="preview-field">
          <label>è§„æ ¼å‚æ•°:</label>
          <div class="value specifications" id="preview-specifications">-</div>
        </div>
      </div>
      
      <!-- æå–çŠ¶æ€ç»Ÿè®¡ -->
      <div class="preview-section">
        <h4>ğŸ“Š æå–çŠ¶æ€ç»Ÿè®¡</h4>
        <div class="extraction-stats">
          <div class="stat-item">
            <span class="stat-label">æˆåŠŸæå–:</span>
            <span class="stat-value success" id="success-count">0</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">æå–å¤±è´¥:</span>
            <span class="stat-value failed" id="failed-count">0</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">å®Œæ•´åº¦:</span>
            <span class="stat-value percentage" id="completion-rate">0%</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- è°ƒè¯•ä¿¡æ¯åŒºåŸŸ -->
    <div id="debug-info" class="debug-info" style="display: none;">
      <h3>ğŸ› è°ƒè¯•ä¿¡æ¯</h3>
      <pre id="debug-content"></pre>
    </div>

    <!-- å›¾ç‰‡å¤§å›¾æŸ¥çœ‹æ¨¡æ€æ¡† -->
    <div id="image-modal" class="image-modal">
      <span class="close">&times;</span>
      <img id="modal-image" src="" alt="å¤§å›¾">
    </div>



    <script>
    // æ¨¡æ‹ŸPopupManagerçš„æ–¹æ³•
      function updatePreviewField(elementId, value, isLongText = false) {
        const element = document.getElementById(elementId);
        if (element) {
          if (value && value.trim() !== '') {
            element.textContent = isLongText ? truncateText(value, 200) : value;
            element.title = isLongText ? value : '';
            element.style.color = '#212529';
            console.log(`âœ… æ›´æ–°å­—æ®µ ${elementId}:`, value);
          } else {
            element.textContent = '-';
            element.style.color = '#6c757d';
            console.log(`âš ï¸ å­—æ®µ ${elementId} ä¸ºç©ºï¼Œè®¾ç½®ä¸º -`);
          }
        } else {
          console.error(`âŒ æ‰¾ä¸åˆ°å…ƒç´ : ${elementId}`);
        }
      }
    
    function updateImagePreview(elementId, images, type) {
      const container = document.getElementById(elementId);
      if (!container) return;
      
      if (type === 'single') {
        if (images && images.trim() !== '') {
          container.innerHTML = `<img src="${images}" alt="ä¸»å›¾" title="ç‚¹å‡»æŸ¥çœ‹å¤§å›¾" onclick="showImageModal('${images}')">`;
        } else {
          container.innerHTML = '<div class="no-image">æœªæå–åˆ°ä¸»å›¾</div>';
        }
      } else {
        if (images && images.length > 0) {
          const imageHtml = images.map((img, index) => 
            `<img src="${img}" alt="å›¾ç‰‡${index + 1}" title="ç‚¹å‡»æŸ¥çœ‹å¤§å›¾" onclick="showImageModal('${img}')">`
          ).join('');
          container.innerHTML = imageHtml;
        } else {
          const noImageText = elementId.includes('carousel') ? 'æœªæå–åˆ°è½®æ’­å›¾' : 'æœªæå–åˆ°è¯¦æƒ…å›¾';
          container.innerHTML = `<div class="no-image">${noImageText}</div>`;
        }
      }
    }
    
    function updateExtractionStats(product) {
      const fields = [
        product.title,
        product.productId,
        product.price,
        product.minOrderQuantity,
        product.unit,
        product.supplierName,
        product.supplierLocation,
        product.mainImage,
        product.carouselImages?.length > 0 ? 'has_images' : null,
        product.detailImages?.length > 0 ? 'has_images' : null,
        product.category,
        product.description,
        product.specifications
      ];
      
      const successCount = fields.filter(field => field && field.toString().trim() !== '').length;
      const totalCount = fields.length;
      const failedCount = totalCount - successCount;
      const completionRate = Math.round((successCount / totalCount) * 100);
      
      document.getElementById('success-count').textContent = successCount;
      document.getElementById('failed-count').textContent = failedCount;
      document.getElementById('completion-rate').textContent = `${completionRate}%`;
    }
    
    function truncateText(text, maxLength) {
      if (!text || text.length <= maxLength) return text;
      return text.substring(0, maxLength) + '...';
    }
    
    function displayProductInfo(product) {
      const previewDiv = document.getElementById('product-preview');
      previewDiv.style.display = 'block';
      
      updatePreviewField('preview-title', product.title);
      updatePreviewField('preview-product-id', product.productId);
      updatePreviewField('preview-price', product.price ? `Â¥${product.price}` : null);
      updatePreviewField('preview-min-order', product.minOrderQuantity);
      updatePreviewField('preview-unit', product.unit);
      
      updatePreviewField('preview-supplier', product.supplierName);
      updatePreviewField('preview-location', product.supplierLocation);
      
      updateImagePreview('preview-main-image', product.mainImage, 'single');
      updateImagePreview('preview-carousel-images', product.carouselImages, 'gallery');
      updateImagePreview('preview-detail-images', product.detailImages, 'gallery');
      
      document.getElementById('carousel-count').textContent = product.carouselImages?.length || 0;
      document.getElementById('detail-count').textContent = product.detailImages?.length || 0;
      
      updatePreviewField('preview-category', product.category);
      updatePreviewField('preview-description', product.description, true);
      updatePreviewField('preview-specifications', product.specifications, true);
      
      updateExtractionStats(product);
    }
    
    // æµ‹è¯•æ•°æ®
    function testCompleteData() {
      const product = {
        title: 'æ±½è½¦LEDå¤§ç¯ H7 è¶…äº®ç™½å…‰ 6000K è½¦ç¯æ”¹è£…ä¸“ç”¨',
        productId: '12345678901',
        price: '89.00',
        minOrderQuantity: '2',
        unit: 'å¯¹',
        supplierName: 'å¹¿å·å¸‚å¤©æ²³åŒºæ˜äº®è½¦ç¯å‚',
        supplierLocation: 'å¹¿ä¸œçœå¹¿å·å¸‚',
        mainImage: 'https://picsum.photos/400/400?random=1',
        carouselImages: [
          'https://picsum.photos/400/400?random=2',
          'https://picsum.photos/400/400?random=3',
          'https://picsum.photos/400/400?random=4'
        ],
        detailImages: [
          'https://picsum.photos/600/400?random=5',
          'https://picsum.photos/600/400?random=6'
        ],
        category: 'æ±½è½¦ç”¨å“ > è½¦ç¯ > LEDå¤§ç¯',
        description: 'è¿™æ˜¯ä¸€æ¬¾é«˜å“è´¨çš„æ±½è½¦LEDå¤§ç¯ï¼Œé‡‡ç”¨è¿›å£èŠ¯ç‰‡ï¼Œäº®åº¦é«˜ï¼Œå¯¿å‘½é•¿ï¼Œå®‰è£…ç®€å•ï¼Œé€‚ç”¨äºå„ç§è½¦å‹ã€‚äº§å“é€šè¿‡CEè®¤è¯ï¼Œè´¨é‡å¯é ã€‚',
        specifications: {
          'åŠŸç‡': '36W',
          'ç”µå‹': '12V-24V',
          'è‰²æ¸©': '6000K',
          'å…‰é€šé‡': '3600LM',
          'é˜²æ°´ç­‰çº§': 'IP67',
          'æè´¨': 'é“åˆé‡‘æ•£çƒ­'
        },
        extractedAt: new Date().toISOString()
      };
      // ä¿å­˜æµ‹è¯•æ•°æ®åˆ°å…¨å±€å˜é‡
      window.currentTestData = product;
      displayProductInfo(product);
    }
    
    function testPartialData() {
      const product = {
        title: 'æ±½è½¦è„šå«',
        productId: '98765432109',
        price: '45.50',
        minOrderQuantity: '',
        unit: '',
        supplierName: '',
        supplierLocation: 'æµ™æ±Ÿçœ',
        mainImage: 'https://picsum.photos/400/400?random=7',
        carouselImages: [],
        detailImages: [
          'https://picsum.photos/600/400?random=8'
        ],
        category: '',
        description: '',
        specifications: ''
      };
      displayProductInfo(product);
    }
    
    function testEmptyData() {
      const product = {
        title: '',
        productId: '',
        price: '',
        minOrderQuantity: '',
        unit: '',
        supplierName: '',
        supplierLocation: '',
        mainImage: '',
        carouselImages: [],
        detailImages: [],
        category: '',
        description: '',
        specifications: ''
      };
      displayProductInfo(product);
    }
    
    function clearPreview() {
      const previewDiv = document.getElementById('product-preview');
      if (previewDiv) {
        previewDiv.style.display = 'none';
      }
      console.log('ğŸ§¹ æ¸…ç©ºé¢„è§ˆ');
    }

    function showDebugInfo() {
      const debugDiv = document.getElementById('debug-info');
      const debugContent = document.getElementById('debug-content');
      
      if (debugDiv && debugContent) {
        const debugData = {
          'å½“å‰æ—¶é—´': new Date().toLocaleString(),
          'é¢„è§ˆåŒºåŸŸçŠ¶æ€': document.getElementById('product-preview')?.style.display || 'none',
          'å¯ç”¨å…ƒç´ ': {
            'product-preview': !!document.getElementById('product-preview'),
            'preview-title': !!document.getElementById('preview-title'),
            'preview-main-image': !!document.getElementById('preview-main-image'),
            'open-large-preview': !!document.getElementById('open-large-preview')
          },
          'å½“å‰äº§å“æ•°æ®': window.currentTestData || null
        };
        
        debugContent.textContent = JSON.stringify(debugData, null, 2);
        debugDiv.style.display = debugDiv.style.display === 'none' ? 'block' : 'none';
      }
    }
    
    // å›¾ç‰‡æ¨¡æ€æ¡†åŠŸèƒ½
    function showImageModal(imageSrc) {
      const modal = document.getElementById('image-modal');
      const modalImage = document.getElementById('modal-image');
      
      modalImage.src = imageSrc;
      modal.style.display = 'block';
    }
    
    function hideImageModal() {
      const modal = document.getElementById('image-modal');
      modal.style.display = 'none';
    }


    
    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', () => {
      const modal = document.getElementById('image-modal');
      const closeBtn = modal.querySelector('.close');
      
      if (closeBtn) {
        closeBtn.onclick = hideImageModal;
      }
      
      if (modal) {
        modal.onclick = function(event) {
          if (event.target === modal) {
            hideImageModal();
          }
        };
      }
      
      if (largePreviewModal) {
        largePreviewModal.onclick = function(event) {
          if (event.target === largePreviewModal) {
            hideLargePreview();
          }
        };
      }
      
      document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
          hideImageModal();
          hideLargePreview();
        }
      });
    });
  </script>
  <script src="popup.js"></script>
</body>
</html>