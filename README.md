# Vehicle Supplies WebSite

这是一个独立站的电商系统，主要提供以下功能

a. 产品的展示，询价，下单，
b. 用户信息，订单管理
c. 物流跟踪功能

系统使用vue 做前端，nodejs 做后端，mysql 做DB
前端目录: frontend
后端目录: backed
DB 目录: db

## 系统模块

### 1. 系统后台

系统后台在backend 目录，主要提供动态数据配置，生成的功能。详细功能定义如下

#### 前端数据接口
返回前端需要的动态数据，包括配置的图片文件地址，配置的文字内容。
#### 后台管理接口 
用于配置前端需要的图片和文字信息。


### 2. 系统前台

系统前台在frontend 目录，用vue 框架，通过component Id 从后端取回图片地址和文字信息

### 3. DB
提供用户信息存储，产品信息存储，订单信息， 物流信息存储功能

## 业务模块

### 1. 通用模块
Header:
所有业务模块的顶部，都有一个公司logo, 主业务模块的导航栏，用户登录按钮，在logo 下方，有一块滚动展现的公司的banner 图片，图片应该是3张连动播放。
logo 图片，主业务模块导航栏，用户登录按钮，banner 图片，这些信息，从后台的前端数据接口中获取。

Footer:
所有业务模块的底部，有一个统一的模块，分成4块，
1. 公司的信息，包括公司的地址，公司的电话，公司的邮箱，这些信息从后台的公司信息接口中获取。
2. 网站的导航栏，包括网站的首页，产品列表，关于，新闻，联系，用户模块。
3. 产品的分类，包括产品的分类名称，产品的分类描述，这些信息从产品分类列表API 获得，点击每个分类，跳到产品列表页面，显示该分类的产品。
4. 公司的社交链接，包括公司的微信，公司的微博，公司的QQ，公司的抖音，公司的小红书。这些信息从后台的公司信息接口中获取。

在最底部是网站的版权信息。

主业务模块: 包括主页面，产品列表页面，关于页面，新闻信息页面，联系页面，用户模块。

### 2. 主页面
在主页面, 主要包括以下功能
a. 展现按产品分类展现每个产品的前10 个重要产品的缩略图。点击缩略图，进入产品详情页面。
b. 展现一个简要介绍公司文化的栏目，

### 3. 产品列表页面
产品列表页面，按产品分类展示产品，显示产品图片，产品名称，每个商品可以直接加入购物车。

### 4. 产品详情页面
产品详情页面，展示产品的详细信息，包括产品的图片，产品的描述，产品的价格，产品的库存，产品的属性，产品的评论。
在产品详情页面，有一个询价按钮，点击询价按钮，进入询价页面。

### 5. 关于页面
关于页面，展示公司的简介，公司的历史，公司的文化，公司的团队，公司的资质，公司的荣誉。

### 6. 新闻信息页面
新闻信息页面，展示公司的新闻信息，包括公司的新闻，公司的活动，公司的优惠，公司的促销。
现在我们开始用common content 的数据实现News   的UI, News 可以用 About Us 的导航菜单，点击一个菜单后把对应语言的所有Content 的主图和标题做成一个列表，点击列表中的一条后，进入News的详情页面，在News详情页，展现content 的详细内容，并有返回，下一条，上一条的功能

### 7. 联系页面
联系页面，展示公司的联系方式，包括公司的地址，公司的电话，公司的邮箱，公司的微信。
在联系页面，有一个联系我们的表单，用户在表单中填写姓名，邮箱，电话，主题，内容，点击提交按钮，会把用户的信息存到数据库中。后台系统及时的把用户的留言发送给一个邮件组或者对应的公司邮箱。业务人员可以通过员工邮箱回复用户



### 8. 用户模块

用户模块，包括用户登录，用户注册，用户订单管理，用户物流跟踪。

#### 8.1. 用户注册模块
现在只支持用户邮箱注册，用户需要在注册页面，填入有效邮箱和他的密码，密码需要满足足够的强度，并校验是否是机器人，并勾选用户协议。 

用户必须注册后，会发激活邮件到用户邮箱中，用户必须到注册的邮箱中激活后，才能正常使用。

用户忘记密码，也必须通过注册的邮箱重置密码。
#### 8.2. 用户登录模块
用户在未登录的情况下，Header 上面的用户按钮，鼠标一上去是一个下拉菜单，下拉菜单有两个选项，一个是登录，一个是注册。
在未登录的场景下，用户点击登录按钮或者进入任何用户信息相关页面之前(包括购物车，用户订单页面)，先进入登录页面，用户输入用户名和密码，点击登录按钮，再跳转到相应的页面。
用户点击注册按钮，用户注册模块

登录进去之后，Header 上面的用户按钮，鼠标一上去是一个下拉菜单，下拉菜单有两个选项，一个是用户订单，一个是退出登录。

### 9. 购物车模块
购物车模块，包括购物车列表，购物车添加，购物车删除，购物车清空，购物车下单。
可以在产品列表页面和产品详情页面，点击添加到购物车按钮，把产品添加到购物车。

购物车列表页面，展示购物车中的产品列表，包括产品的图片，产品的名称，产品的价格，产品的数量，产品的总价。

在购物车列表页面，有一个结算按钮，点击结算按钮，进入结算页面。


### 10. 订单管理模块
订单管理模块，包括订单列表，订单详情，订单取消，订单确认，订单发货，订单完成。

### 11. 物流跟踪模块
物流跟踪模块，包括物流跟踪列表，物流跟踪详情。

### 12. 结算流程
有两种结算方式. 在购物车页面，有Paypal 结算和结算两个按钮，分别进入Paypal 结算和普通结算。
1. Paypal结算， 在购物车页面，点击Paypal Checkout按钮，会跳转到Paypal 结算页面。在Paypal结算页面，把用户在购物车选中的商品作为订单信息，用户地址信息，PayPal SDK 产生的按钮放在一个页面。 用户必须填入用户地址，用户的姓名，用户的电话，用户的邮箱。
   
   点击PayPal Checkout 或者 Credit/Debit Cared 按钮后，PayPal JDK 会回调createOrder函数，需要在此把订单信息，用户地址信息做为参数，调用后端的PalPayCreateOrder API，后端接口调用OrdersController 的createOrder方法创建订单， 并调用我们自己的InitOrder 方法,把订单信息和地址信息插入order 和 order_items 表,此时候订单是未支付状态。在order 表需要有字段保存Paypal 的订单Id， PalPayCreateOrder API返回系统自己的OrderId 和 Paypal 的OrderId到前端，前端的createOrder 函数需要把后端返回的Papal Order Id 返回给PayPal Javascript SDK.
   PayPal JDK 会回调onApprove 函数，需要在此调用后端API，后端接口确认订单，，onApprove 函数需要处理3种情况
   (1) Recoverable INSTRUMENT_DECLINED -> call actions.restart()
   (2) Other non-recoverable errors -> Show a failure message
   (3) Successful transaction -> Show confirmation or thank you message

2. 微信支付宝结算，在购物车页面，点击结算按钮，进入普通结算页面，普通结算页面使用微信和支付宝支付,普通结算页面和PayPal 结算页面类似，把订单信息，用户地址信息，以及微信和支付宝的选择项放在一个页面。 
   用户必须填入用户地址，用户的姓名，用户的电话，用户的邮箱。
   点击微信或者支付宝的产生二维码按钮，需要在此把订单信息，用户地址信息做为参数，调用后端CommonCreateOrder API, CommonCreateOrder API调用我们自己的InitOrder 方法,把订单信息和地址信息插入order 和 order_items 表,此时候订单是未支付状态,PayPalOrderId 字段是空，CommonCreateOrder返回系统OrderId, 此时订单状态是未支付状态，前端再用orderId 作为参数，调用后端API产生微信和支付宝的二维码图片，前端再把二维码图片显示在页面上。
   产生了二维码后，前端界面显示二维码，刷新二维码的按钮。前端定时刷新二维码，或者用户点击刷新二维码按钮，都会调用后端API刷新二维码图片，前端再把二维码图片显示在页面上。

   需要提供两个回调API 注册到微信和支付宝的回调接口，当用户支付成功后，微信和支付宝会回调我们的接口，我们的接口需要处理3种情况
   (1) 支付成功 -> 调用后端的CommonOrderPaySuccess API, 把订单状态改为已支付状态
   (2) 支付失败 -> 调用后端的CommonOrderPayFail API, 把订单状态改为已取消状态
   (3) 支付取消 -> 调用后端的CommonOrderPayCancel API, 把订单状态改为已取消状态


## 管理后台

管理后台，包括公司信息管理, 产品类型，产品管理，订单管理，用户管理，物流管理。

### 1. 公司信息管理

公司信息管理可以设置以下信息,
公司信息(公司地址，联系人姓名，电话，公司简介)，以及Logo图片，联系人的微信扫码图片

无论logo 和微信图片是否存在，都有上传文件功能，当图片已经存在可以预览，否则显示图片不存在的信息

公司logo图片上传后存在固定的文件地址，按照上传文件的格式，如果上传的文件是png, 则文件地址是asset/images/logo.png，如果是jpg 则文件地址是asset/images/logo.jpg, 如果文件存在，上传后就覆盖这个文件。

微信的图片上传后一样存在固定的文件地址，按照上传文件的格式，如果上传的文件是png, 则文件地址是asset/images/wechat.png，如果是jpg 则文件地址是asset/images/wechat.jpg, 如果文件存在，上传后就覆盖这个文件。

### 2. 产品分类
产品分类包括 类型名称，类型编码，排序字段，状态(上架，下架), 描述。
类型编码32 字节，必须唯一， 在添加和修改接口必须检查，如果有重复需要报错

### 3. 产品管理

产品管理，包括产品分类管理，产品管理，可以设置如下项目
a. 产品的名称, 产品的编号，产品分类，产品价格，产品库存， 产品状态(上架，下架)， 产品类型，（有两种: 代销， 自营）。
产品的编号, 用64 字节，必须唯一。 在添加和修改接口必须检查，如果有重复需要报错。 另外提供一个生成production_code 的接口给前端调用，让前端在新建一个产品的时候, 选择了一个类型之后，可以调用这个接口生成一个默认的code，这个逻辑用catergory_code 做前缀，用这个类型数量最大值做后缀

b. 产品的缩略图，产品的缩略图会用在主页和产品列表界面， 只能有一张。
c. 产品的轮播图，会在产品的详情页显示，可以有多张。
d. 产品的简介，用HTML格式存储文本信息，前端使用配置的HTML文本显示简介信息。
e. 产品详情 可以使用HTML和MarkDown存储文本和图片信息。

产品图片的逻辑，1. 主图只能传一张，轮播图可以上传多张。 2. product_images 表的product_id 可以为空，在新建一个产品的时候可以先上传图片，这个时候产品图片表里对应相应图片的产品id 是空，最后点保存的时候，把产品id 为空的图片记录才修改为正确的产品id. 

### 4. 订单管理



### 用户管理
系统应该有三类用户，一种是产品用户，是使用产品的人，他们可以下单，询价，这种用户在产品界面上可以通过邮箱，手机号注册，一种是管理员，管理员是系统的内置用户，首先DB 里面默认有一个admin 权限的用户，这个用户登录进去以后可以添加其他管理员。第三种是业务人员, 业务人员是负责处理用户的订单，发货，退款等业务。在user 表里面要有userRole 的管理。 


用户的校验机制，应该使用慢哈希加盐的方式。密码的存储方式应该是：
​步骤1：用户输入密码后，系统生成随机盐值。
​步骤2：将盐值与密码拼接（例如 salted_password = password + salt）。
​步骤3：使用哈希算法（如SHA-256、bcrypt）对拼接后的字符串进行哈希计算。
​步骤4：将盐值和哈希值一起存储到数据库中。盐值无需加密，直接明文存储即可

验证用户登录时，需从数据库提取原盐值，与用户输入的密码重新拼接并哈希，再与存储的哈希值比对。如果盐值丢失，则无法正确验证密码。

需要实现一个业务人员的管理功能，业务人员也是一个user, 应该在uses 里面有一个role 来区别业务人员。 有一个业务人员的分组管理表，可以业务人员分组管理，每个组有一个组名，组邮箱。 每个产品的普通用户可以对应一个业务组，有一个组是默认组，当普通用户注册之后默认关联到这个默认的业务组。当普通用户发出联系信息后邮件，后台通过查询他关联的业务组，来发邮件到组的邮箱。 在后台管理页面需要支持用户管理功能，管理员可以增删改管理员和业务人员的用户信息但不能修改普通用户信息，管理人员创建管理组，分配业务人员到对应的组。 业务人员登录之后可以看到订单信息，修改订单信息，可以看到联系人信息，但不能修改其他设置。
### 物流管理

 


## 登录流程
需要分开产品和管理员登录的UI 和逻辑，管理员登录需要检查user_rule 是admin。 管理员用户登录后可以访问后台管理界面，但是不能访问产品界面相关的购物车，订单信息。 
产品登录 用户必须user_rule 是user, 而且是激活用户。
当产品用户登录后可以访问购物车，他本人的订单，他本人的信息。

这两种用户登录后他们的用户Id和用户名存在JWTToken 里面，JWTToken 以Cookie存到用户机器， 对cookie 做如下设置
设置 HttpOnly标志， 禁止 JavaScript 访问cookie，防止 XSS 攻击窃取敏感信息
如果是https访问，设置 Secure 标准确保仅 HTTPS 传输，防止数据明文泄露
设置 SameSite=Strict/Lax 限制跨站请求，降低 CSRF 风险

前端服务器收到cookie, 之后把cookie 转换到http 的Authorization header 中，传输到后端。后端用一个统一的接口拦截所以的请求从Jwttoken 中去到userId信息，为后面的逻辑服务

## 网站语言设置
我们需要设实现网站的语言配置，首先在后端有一个语言的翻译表，里面提供了一个code 到 不同语言的对照，在管理后台可以往这个表里面添加数据，表字段主要有code, lang, value。 每次在产品网站打开的时候先根据请求的IP地址所在的国家或者区域定位默认的语言，如果定位到的国家语言在翻译表里面没有，就默认使用英文。
用户可以在header 上的语言切换框里面切换语言，切换语言的时候，从新从后端的翻译表里面取到数据，前端的所有菜单和label 都要做翻译。

## 重置密码
用户在忘记密码的时候，需要输入邮箱，系统会发送一个重置密码的链接到用户邮箱，用户点击链接后，会跳转到重置密码的页面，用户输入新的密码，点击保存按钮，系统会把新的密码保存到数据库。